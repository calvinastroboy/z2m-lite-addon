import{j as t}from"./ui-BNQquHvV.js";import{r as l,c as O}from"./vendor-DN6e53jq.js";import{b as v,u as w,d as i,t as d}from"./index-BUo07_5n.js";import{e as $,P as A,g as D,h as F,i as E}from"./icons-Cg0FTVUT.js";import"./i18n-BzK7rx8x.js";function B(){const m=v(),u=w(s=>s.byId),x=l.useMemo(()=>{const s={};for(const[,n]of Object.entries(u))s[n.ieee_address]={state:n.state?.state,brightness:n.state?.brightness};return s},[u]),g=l.useCallback(s=>m.getGroupAggregateState(s,x),[m,x]),j=l.useCallback(s=>m.getGroupAverageBrightness(s,x),[m,x]),G=l.useCallback(async(s,n)=>{await i.controlGroup(s,n)},[]),b=l.useCallback(async s=>{await i.createGroup(s)},[]),p=l.useCallback(async s=>{await i.deleteGroup(s)},[]),h=l.useCallback(async(s,n)=>{await i.addGroupMember(s,n)},[]),N=l.useCallback(async(s,n)=>{await i.removeGroupMember(s,n)},[]);return{groups:m.groups,getGroup:m.getGroup,getAggregateState:g,getAverageBrightness:j,controlGroup:G,createGroup:b,deleteGroup:p,addMemberToGroup:h,removeMemberFromGroup:N}}function R(){const m=O(),{groups:u,getAggregateState:x}=B(),g=w(e=>e.byId),j=w(e=>e.allIds),[G,b]=l.useState(!1),[p,h]=l.useState(""),[N,s]=l.useState(null),n=j.map(e=>g[e]).filter(e=>!!e&&e.type!=="coordinator"),k=async()=>{if(p.trim())try{await i.createGroup(p.trim()),d.success(`群組「${p}」已建立`),h(""),b(!1)}catch{d.error("建立群組失敗")}},_=async e=>{if(confirm(`確定要刪除群組「${e}」？`))try{await i.deleteGroup(e),d.success(`群組「${e}」已刪除`)}catch{d.error("刪除群組失敗")}},S=async(e,a)=>{const r=a==="ON"?"OFF":"ON";try{await i.controlGroup(e,{state:r})}catch{d.error("控制群組失敗")}},z=async(e,a)=>{const r=u.find(c=>c.friendly_name===e);if(r){const c=[...r.members,{ieee_address:a.ieee_address,endpoint:1}];v.getState().updateGroup(r.id,{members:c})}try{await i.addGroupMember(e,a.friendly_name),d.success(`${a.friendly_name} 已加入「${e}」`)}catch{r&&v.getState().updateGroup(r.id,{members:r.members}),d.error("加入失敗")}},M=async(e,a)=>{const r=u.find(c=>c.friendly_name===e);if(r){const c=r.members.filter(y=>y.ieee_address!==a.ieee_address);v.getState().updateGroup(r.id,{members:c})}try{await i.removeGroupMember(e,a.friendly_name),d.success(`${a.friendly_name} 已從「${e}」移除`)}catch{r&&v.getState().updateGroup(r.id,{members:r.members}),d.error("移除失敗")}},I=e=>new Set((e.members??[]).map(a=>a.ieee_address));return t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between px-5 pb-4 pt-2",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>m("/"),className:"flex h-8 w-8 items-center justify-center rounded-full",style:{background:"var(--bg-card)",minHeight:"auto",minWidth:"auto"},children:t.jsx($,{size:18})}),t.jsx("h1",{className:"text-[24px] font-bold",children:"群組"})]}),t.jsx("button",{onClick:()=>b(!0),className:"flex h-10 w-10 items-center justify-center rounded-full border transition-all active:scale-[0.92]",style:{background:"var(--bg-card)",borderColor:"var(--z2m-border)"},children:t.jsx(A,{size:18})})]}),G&&t.jsxs("div",{className:"mx-5 mb-4 rounded-2xl border p-4",style:{background:"var(--bg-card)",borderColor:"var(--z2m-border)"},children:[t.jsx("div",{className:"mb-3 text-sm font-medium",children:"新增群組"}),t.jsx("input",{type:"text",value:p,onChange:e=>h(e.target.value),placeholder:"群組名稱",className:"mb-3 w-full rounded-xl border px-4 py-3 text-sm",style:{background:"var(--bg-elevated)",borderColor:"var(--z2m-border)",color:"var(--text-primary)"},onKeyDown:e=>e.key==="Enter"&&k(),autoFocus:!0}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>b(!1),className:"flex-1 rounded-xl py-2.5 text-sm",style:{background:"var(--bg-elevated)",color:"var(--text-secondary)"},children:"取消"}),t.jsx("button",{onClick:k,className:"flex-1 rounded-xl py-2.5 text-sm font-semibold",style:{background:"var(--z2m-accent)",color:"#000"},children:"建立"})]})]}),t.jsxs("div",{className:"space-y-3 px-5 pb-6",children:[u.length===0&&t.jsx("div",{className:"py-12 text-center text-sm",style:{color:"var(--text-tertiary)"},children:"尚無群組，點擊 ➕ 新增"}),u.map(e=>{const a=x(e.id),r=a==="all_on"||a==="mixed",c=I(e),y=n.filter(o=>c.has(o.ieee_address)),C=n.filter(o=>!c.has(o.ieee_address)),f=N===e.friendly_name;return t.jsxs("div",{className:"rounded-2xl border p-4 transition-all",style:{background:r?"var(--z2m-accent-soft)":"var(--bg-card)",borderColor:r?"var(--z2m-accent-border)":"var(--z2m-border)"},children:[t.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-[15px] font-semibold",children:e.friendly_name}),t.jsxs("div",{className:"text-[12px]",style:{color:"var(--text-tertiary)"},children:[y.length," 個設備"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>s(f?null:e.friendly_name),className:"flex h-8 w-8 items-center justify-center rounded-full",style:{background:f?"var(--z2m-accent)":"transparent",color:f?"#000":"var(--text-tertiary)",minHeight:"auto",minWidth:"auto"},children:t.jsx(D,{size:15})}),t.jsx("div",{className:"relative h-[24px] w-[42px] cursor-pointer rounded-full transition-colors duration-300",style:{background:r?"var(--z2m-accent)":"var(--bg-elevated)"},onClick:()=>S(e.friendly_name,r?"ON":"OFF"),children:t.jsx("div",{className:"absolute top-[2px] h-[20px] w-[20px] rounded-full bg-white transition-transform duration-300",style:{transform:r?"translateX(20px)":"translateX(2px)",boxShadow:"0 1px 3px rgba(0,0,0,0.3)"}})}),t.jsx("button",{onClick:()=>_(e.friendly_name),className:"flex h-8 w-8 items-center justify-center rounded-full",style:{color:"var(--text-tertiary)",minHeight:"auto",minWidth:"auto"},children:t.jsx(F,{size:16})})]})]}),y.length>0&&t.jsx("div",{className:"flex flex-wrap gap-1.5",children:y.map(o=>t.jsxs("span",{className:"flex items-center gap-1 rounded-lg px-2.5 py-1 text-[11px]",style:{background:"var(--bg-elevated)",color:"var(--text-secondary)"},children:[o.friendly_name,f&&t.jsx(E,{size:12,className:"cursor-pointer",style:{color:"var(--z2m-red)"},onClick:()=>M(e.friendly_name,o)})]},o.friendly_name))}),f&&t.jsxs("div",{className:"mt-3 border-t pt-3",style:{borderColor:"var(--z2m-border)"},children:[t.jsx("div",{className:"mb-2 text-[11px]",style:{color:"var(--text-tertiary)"},children:"點擊設備加入群組："}),C.length>0?t.jsx("div",{className:"flex flex-wrap gap-1.5",children:C.map(o=>t.jsxs("span",{className:"cursor-pointer rounded-lg px-2.5 py-1 text-[11px] transition-colors active:scale-[0.95]",style:{background:"var(--bg-primary)",color:"var(--text-secondary)",border:"1px dashed var(--z2m-border)"},onClick:()=>z(e.friendly_name,o),children:["+ ",o.friendly_name]},o.friendly_name))}):t.jsx("span",{className:"text-[11px]",style:{color:"var(--text-tertiary)"},children:"所有設備已加入"})]})]},e.id)})]})]})}export{R as GroupManagement};
//# sourceMappingURL=GroupManagement-BYb6U7dP.js.map
